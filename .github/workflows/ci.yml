name: CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-sonar-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
          cache: true

      - name: Build with Go
        run: go build ./...

      - name: Sonar analysis
        id: sonar_scan
        continue-on-error: true
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=example
            -Dsonar.sources=.
            -Dsonar.working.directory=/tmp/.scannerwork-${{ github.run_number }}

      - name: Report Sonar connection error and continue
        if: steps.sonar_scan.outcome == 'failure'
        run: |
          echo "::warning::Sonar analysis failed (possible connection/auth issue). Workflow continues."

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        id: docker_login
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Report Docker Hub login error and continue
        if: steps.docker_login.outcome == 'failure'
        run: |
          echo "::warning::Docker Hub login failed (possible connection/auth issue). Workflow continues."

      - name: Build and push Docker image
        id: docker_build_push
        continue-on-error: true
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            docker.io/afrodriguez68/example:${{ github.run_number }}
            docker.io/afrodriguez68/example:latest

      - name: Report Docker push error and continue
        if: steps.docker_build_push.outcome == 'failure'
        run: |
          echo "::warning::Docker build/push failed (possible registry/network issue). Workflow continues."
